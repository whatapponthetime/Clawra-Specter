'use client';

import React, { useState, useEffect } from 'react';
import ReactMarkdown from 'react-markdown';
import { Loader2, ShieldAlert, Terminal, Lock, Globe, Search, Play, FileText, CheckCircle2, ChevronRight } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import { cn } from '@/lib/utils';
import { Card } from '@/components/ui/card';
import { Captcha } from '@/components/ui/captcha';

// Types for Simulated Progress
type ScanPhase = 'IDLE' | 'RECON' | 'AUDIT' | 'EXPLOIT' | 'REPORT' | 'COMPLETE';

interface ReconData {
    techStack: string[];
    robotsStatus: string;
    sitemapStatus: string;
}

export default function PentestForm() {
    const [url, setUrl] = useState('');
    const [loading, setLoading] = useState(false);
    const [report, setReport] = useState<string | null>(null);
    const [reconData, setReconData] = useState<ReconData | null>(null);
    const [error, setError] = useState<string | null>(null);
    const [statusLog, setStatusLog] = useState<string[]>([]); // Array of logs
    const [currentPhase, setCurrentPhase] = useState<ScanPhase>('IDLE');
    const [trialsLeft, setTrialsLeft] = useState<number | null>(null);
    const [isCaptchaValid, setIsCaptchaValid] = useState(false);

    // Auto-scroll logs
    const logsEndRef = React.useRef<HTMLDivElement>(null);
    useEffect(() => {
        logsEndRef.current?.scrollIntoView({ behavior: "smooth" });
    }, [statusLog]);

    const addLog = (msg: string) => {
        setStatusLog(prev => [...prev, `[${new Date().toLocaleTimeString()}] ${msg}`]);
    };

    const handleScan = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!url || !isCaptchaValid) return; // Constraint check

        setLoading(true);
        setError(null);
        setReport(null);
        setStatusLog([]);
        setCurrentPhase('RECON');

        // Initial Logs
        addLog(`Initializing Clawra Specter Protocol v3.0...`);
        addLog(`Target Acquired: ${url}`);
        addLog(`Verifying Human Verification... PASS`);
        addLog(`Checking local constraints...`);

        // Phases simulation (Visual only, actual API handles logic)
        const phaseInterval = setInterval(() => {
            setCurrentPhase(prev => {
                if (prev === 'RECON') { addLog("Phase 1: Reconnaissance active. Mapping assets..."); return 'AUDIT'; }
                if (prev === 'AUDIT') { addLog("Phase 2: Vulnerability Audit active. Checking vectors..."); return 'EXPLOIT'; }
                if (prev === 'EXPLOIT') { addLog("Phase 3: Deep analysis. Verifying headers & scripts..."); return 'REPORT'; }
                return prev;
            });
        }, 1200); // Faster updates to fit 5s window

        try {
            // Force minimum 5s wait for "Cinematic" feel
            const [res] = await Promise.all([
                fetch('/api/pentest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url }),
                }),
                new Promise(resolve => setTimeout(resolve, 5000))
            ]);

            const contentType = res.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                const text = await res.text();
                throw new Error(`Server Error (${res.status}): ${text.slice(0, 200)}...`);
            }

            const data = await res.json();
            clearInterval(phaseInterval);

            if (!res.ok) {
                throw new Error(data.error || 'Scan failed');
            }

            setReport(data.report);
            setTrialsLeft(data.remaining);
            setReconData({
                techStack: data.techStack || [],
                robotsStatus: data.robotsStatus || 'Unknown',
                sitemapStatus: data.sitemapStatus || 'Unknown'
            });

            setCurrentPhase('COMPLETE');
            addLog("Analysis Complete. Report generated.");
            addLog(`Remaining Trials: ${data.remaining}`);

        } catch (err: any) {
            clearInterval(phaseInterval);
            setError(err.message || 'Network error occurred.');
            addLog(`ERROR: ${err.message}`);
            setCurrentPhase('IDLE');
        } finally {
            setLoading(false);
        }
    };

    // Phase Step Component
    const PhaseStep = ({ phase, label, icon: Icon }: { phase: ScanPhase, label: string, icon: any }) => {
        const isActive = currentPhase === phase;
        // Simplification for logic: Just check order
        const phasesOrder = ['RECON', 'AUDIT', 'EXPLOIT', 'REPORT', 'COMPLETE'];
        const currentIndex = phasesOrder.indexOf(currentPhase);
        const phaseIndex = phasesOrder.indexOf(phase);
        const isPast = currentIndex > phaseIndex;
        const isCurrent = currentPhase === phase;

        return (
            <div className="flex items-center gap-2 text-sm text-foreground">
                <div className={cn("w-8 h-8 rounded-full border flex items-center justify-center transition-all",
                    isCurrent ? "border-primary bg-primary/20 shadow-[0_0_15px_hsl(var(--primary)/0.5)] animate-pulse" :
                        isPast ? "border-primary/50 bg-primary/10" : "border-white/10 bg-transparent"
                )}>
                    {isPast ? <CheckCircle2 className="w-4 h-4 text-primary" /> : <Icon className="w-4 h-4 text-primary" />}
                </div>
                <span className={cn("font-mono tracking-wider text-xs md:text-sm", isCurrent ? "text-primary font-bold" : "text-slate-400")}>{label}</span>
                {phase !== 'COMPLETE' && <ChevronRight className="w-4 h-4 text-primary/10 mx-1" />}
            </div>
        );
    };

    return (
        <div className="space-y-8">
            {/* Header Card */}
            <div className="text-center space-y-4 mb-8">

                <h1 className="text-4xl md:text-5xl font-bold tracking-tight text-white drop-shadow-sm">
                    AI Security <span className="text-white text-glow">Pentester</span>
                </h1>
                <p className="text-muted-foreground text-lg max-w-2xl mx-auto">
                    Automated reconnaissance and vulnerability assessment powered by Clawra Specter Protocol.
                    <br /><span className="text-xs text-primary/60 border border-primary/20 rounded-full px-2 py-0.5 mt-2 inline-block">BETA ACCESS // 3 TRIALS PER IP</span>
                </p>
            </div>

            {/* Main Interface */}
            <Card className="glass-liquid border-white/10 overflow-hidden relative">
                {/* Top Bar decoration */}
                <div className="h-1 w-full bg-gradient-to-r from-transparent via-white/50 to-transparent opacity-50" />

                <div className="p-8 space-y-8">

                    {/* Input Section */}
                    <form onSubmit={handleScan} className="relative z-10 space-y-4">
                        <div className="flex flex-col md:flex-row gap-4 p-2 bg-black/20 rounded-xl border border-white/5 focus-within:border-primary/50 focus-within:ring-1 focus-within:ring-primary/20 transition-all duration-300">
                            <div className="flex-1 flex items-center px-4 gap-3">
                                <Globe className="w-5 h-5 text-muted-foreground" />
                                <input
                                    type="url"
                                    placeholder="Enter target URL (e.g. https://example.com)"
                                    value={url}
                                    onChange={(e) => setUrl(e.target.value)}
                                    disabled={loading}
                                    className="flex-1 bg-transparent border-none outline-none text-white placeholder:text-muted-foreground/50 h-12 font-mono"
                                    required
                                />
                            </div>
                        </div>

                        {/* Captcha & Action Row */}
                        <div className="flex flex-col md:flex-row gap-4 justify-between items-center">
                            <Captcha
                                onValidate={setIsCaptchaValid}
                                className="bg-black/30 p-2 rounded-lg border border-white/5"
                            />

                            <button
                                type="submit"
                                disabled={loading || !url || !isCaptchaValid}
                                className="w-full md:w-auto bg-primary hover:bg-primary/80 text-primary-foreground font-bold px-8 py-3 rounded-lg flex items-center justify-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-[0_0_20px_hsl(var(--primary)/0.2)] hover:shadow-[0_0_30px_hsl(var(--primary)/0.4)]"
                            >
                                {loading ? (
                                    <Loader2 className="w-5 h-5 animate-spin" />
                                ) : (
                                    <>
                                        <Play className="w-5 h-5 fill-current" />
                                        INITIATE SCAN
                                    </>
                                )}
                            </button>
                        </div>
                    </form>

                    {/* Progress Indicators (Visible during loading) */}
                    <AnimatePresence mode='wait'>
                        {loading && (
                            <motion.div
                                initial={{ opacity: 0, height: 0 }}
                                animate={{ opacity: 1, height: 'auto' }}
                                exit={{ opacity: 0, height: 0 }}
                                className="relative overflow-hidden rounded-xl border border-white/20 bg-black/50 p-6 backdrop-blur-md"
                            >
                                <div className="absolute inset-0 matrix-bg opacity-30 pointer-events-none" />
                                <div className="scanner-line" />

                                <div className="relative z-10 flex flex-wrap items-center justify-center gap-4 md:gap-8">
                                    <PhaseStep phase="RECON" label="RECON" icon={Search} />
                                    <PhaseStep phase="AUDIT" label="AUDIT" icon={ShieldAlert} />
                                    <PhaseStep phase="EXPLOIT" label="ANALYSIS" icon={Lock} />
                                    <PhaseStep phase="COMPLETE" label="REPORT" icon={FileText} />
                                </div>
                            </motion.div>
                        )}
                    </AnimatePresence>

                    {/* Terminal Output (Logs) */}
                    <div className="bg-black/80 rounded-lg border border-white/10 p-4 font-mono text-xs md:text-sm h-48 overflow-y-auto custom-scrollbar shadow-inner">
                        <div className="text-muted-foreground/50 mb-2 border-b border-white/5 pb-2 flex justify-between">
                            <span>TERMINAL OUTPUT</span>
                            <span>CLAWRA_SPECTER_CORE_V3.0</span>
                        </div>
                        <div className="space-y-1">
                            {statusLog.length === 0 && <span className="text-muted-foreground/30 animate-pulse">_ Awaiting target...</span>}
                            {statusLog.map((log, i) => (
                                <motion.div key={i} initial={{ opacity: 0, x: -10 }} animate={{ opacity: 1, x: 0 }} className="text-slate-300">
                                    <span className="text-white/20 mr-2">$</span>{log}
                                </motion.div>
                            ))}
                            <div ref={logsEndRef} />
                        </div>
                    </div>

                    {/* Error Message */}
                    {error && (
                        <motion.div
                            initial={{ opacity: 0, y: 10 }}
                            animate={{ opacity: 1, y: 0 }}
                            className="p-4 bg-red-950/30 border border-red-500/20 rounded-lg text-red-400 flex items-center gap-3"
                        >
                            <ShieldAlert className="w-5 h-5 shrink-0" />
                            <span>{error}</span>
                        </motion.div>
                    )}

                </div>
            </Card>

            {/* Generated Report */}
            <AnimatePresence>
                {report && (
                    <motion.div
                        initial={{ opacity: 0, y: 20 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ duration: 0.5 }}
                    >
                        <div className="flex justify-between items-center mb-4 px-2">
                            <h2 className="text-2xl font-bold text-white flex items-center gap-2">
                                <FileText className="text-primary" /> Security Report
                            </h2>
                            <div className="text-xs font-mono text-muted-foreground border border-white/10 px-3 py-1 rounded-full bg-black/20">
                                SESSION_ID: {Math.random().toString(36).substr(2, 9).toUpperCase()}
                            </div>
                        </div>

                        {/* Recon Dashboard */}
                        {reconData && (
                            <motion.div
                                initial={{ opacity: 0, y: 20 }}
                                animate={{ opacity: 1, y: 0 }}
                                transition={{ delay: 0.2, duration: 0.5 }}
                                className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"
                            >
                                <Card className="p-4 bg-black/40 border-white/20 backdrop-blur-sm">
                                    <div className="text-xs text-muted-foreground mb-1 uppercase tracking-wider">Tech Stack</div>
                                    <div className="flex flex-wrap gap-2 mt-2">
                                        {reconData.techStack.length > 0 ? (
                                            reconData.techStack.map((tech, i) => (
                                                <span key={i} className="px-2 py-1 rounded bg-white/10 text-white text-xs border border-white/20 font-mono">
                                                    {tech}
                                                </span>
                                            ))
                                        ) : (
                                            <span className="text-white/50 text-sm italic">Unknown</span>
                                        )}
                                    </div>
                                </Card>
                                <Card className="p-4 bg-black/40 border-white/20 backdrop-blur-sm">
                                    <div className="text-xs text-muted-foreground mb-1 uppercase tracking-wider">Asset Discovery</div>
                                    <div className="space-y-2 mt-2 font-mono text-xs">
                                        <div className="flex justify-between border-b border-white/5 pb-1">
                                            <span>robots.txt</span>
                                            <span className={cn(reconData.robotsStatus === 'Analyzed' ? "text-white" : "text-yellow-500")}>
                                                {reconData.robotsStatus}
                                            </span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span>sitemap.xml</span>
                                            <span className={cn(reconData.sitemapStatus === 'Analyzed' ? "text-white" : "text-yellow-500")}>
                                                {reconData.sitemapStatus}
                                            </span>
                                        </div>
                                    </div>
                                </Card>
                                <Card className="p-4 bg-black/40 border-white/20 backdrop-blur-sm flex items-center justify-center">
                                    <div className="text-center">
                                        <div className="text-2xl font-bold text-white">35ms</div>
                                        <div className="text-xs text-muted-foreground uppercase tracking-wider">Latency</div>
                                    </div>
                                </Card>
                            </motion.div>
                        )}

                        <Card className="glass-panel border-white/10 overflow-hidden">
                            <div className="p-8 prose prose-invert prose-emerald max-w-none">
                                {/* Markdown Content */}
                                <ReactMarkdown
                                    components={{
                                        h1: ({ node, ...props }) => <h1 className="text-3xl font-bold text-white mb-6 border-b border-white/10 pb-4" {...props} />,
                                        h2: ({ node, ...props }) => <h2 className="text-xl font-semibold text-white mt-8 mb-4 flex items-center gap-2" {...props} />,
                                        h3: ({ node, ...props }) => <h3 className="text-lg font-medium text-white/90 mt-6 mb-3" {...props} />,
                                        ul: ({ node, ...props }) => <ul className="bg-black/20 p-4 rounded-lg border border-white/5 space-y-2 my-4" {...props} />,
                                        li: ({ node, ...props }) => <li className="text-white/80" {...props} />,
                                        code: ({ node, ...props }: { node?: any }) => <code className="bg-black/50 text-slate-200 px-1.5 py-0.5 rounded text-sm font-mono border border-white/5" {...props} />,
                                        pre: ({ node, ...props }) => <pre className="bg-black/50 p-4 rounded-lg overflow-x-auto border border-white/10 my-4" {...props} />,
                                        p: ({ node, ...props }) => <p className="text-muted-foreground leading-relaxed my-3" {...props} />,
                                        strong: ({ node, ...props }) => <strong className="text-white font-semibold" {...props} />
                                    }}
                                >
                                    {report}
                                </ReactMarkdown>
                            </div>

                            {/* Footer of Report */}
                            <div className="bg-black/40 p-4 border-t border-white/10 flex justify-between items-center text-sm text-muted-foreground">
                                <span>Generated by Clawra Specter AI</span>
                                <span>Free Trials Remaining: <span className="text-primary font-bold">{trialsLeft !== null ? trialsLeft : '?'}</span>/3</span>
                            </div>
                        </Card>
                    </motion.div>
                )}
            </AnimatePresence>

        </div>
    );
}
